<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Command Center - TV Fullscreen</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Prop-types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <!-- 4. Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>

    <!-- 5. Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        html, body, #root {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #0f172a;
            color: #ffffff;
        }
        @media (max-width: 1024px) or (max-height: 600px) {
            #root { overflow: auto; }
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .cell-truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-in { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .list-item { transition: background-color 0.2s; }
        .list-item:hover { background-color: rgba(30, 41, 59, 0.8); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        .group:hover .delete-btn { opacity: 1; }
        
        /* 긴장감을 주는 붉은 배경 애니메이션 (매출없음용) */
        @keyframes urgentPulse {
            0%, 100% { background-color: rgba(69, 10, 10, 0.5); border-color: rgba(220, 38, 38, 0.6); box-shadow: 0 0 10px rgba(220, 38, 38, 0.2) inset; }
            50% { background-color: rgba(127, 29, 29, 0.7); border-color: rgba(239, 68, 68, 1); box-shadow: 0 0 30px rgba(220, 38, 38, 0.5) inset; }
        }
        .urgent-box { animation: urgentPulse 1.5s infinite; }

        /* 긴급 문구 번쩍임 효과 */
        @keyframes flashUrgent {
            0%, 50%, 100% { opacity: 1; transform: scale(1); }
            25%, 75% { opacity: 0.5; transform: scale(0.98); }
        }
        .flash-urgent { animation: flashUrgent 0.8s infinite; }

        /* Resizer Styles - Improved Hit Area & Z-Index */
        .resizer-v {
            width: 8px; /* 넓힘 */
            cursor: col-resize;
            background-color: transparent;
            transition: background-color 0.2s;
            flex-shrink: 0;
            z-index: 50; /* 최상위 */
            touch-action: none;
        }
        .resizer-v:hover, .resizer-v.resizing {
            background-color: #3b82f6; /* Blue-500 */
        }
        .resizer-h {
            height: 8px; /* 넓힘 */
            cursor: row-resize;
            background-color: transparent;
            transition: background-color 0.2s;
            flex-shrink: 0;
            z-index: 50; /* 최상위 */
            touch-action: none;
        }
        .resizer-h:hover, .resizer-h.resizing {
            background-color: #3b82f6;
        }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen bg-slate-900"></div>

    <script type="text/babel">
        // ResizeObserver Loop Error 억제
        const resizeObserverLoopErr = /Loop limit exceeded/;
        window.addEventListener('error', (e) => {
            if (resizeObserverLoopErr.test(e.message)) {
                e.stopImmediatePropagation();
            }
        });

        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        const Icon = ({ children, size = 16, className = "", color = "currentColor", onClick }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            LayoutDashboard: (p) => <Icon {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></Icon>,
            RefreshCw: (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>,
            Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Briefcase: (p) => <Icon {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></Icon>,
            Layers: (p) => <Icon {...p}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></Icon>,
            DollarSign: (p) => <Icon {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></Icon>,
            Crown: (p) => <Icon {...p}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></Icon>,
            Edit: (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>,
            X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
            Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
            Trash: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></Icon>,
            Save: (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>,
            Target: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></Icon>,
            Building: (p) => <Icon {...p}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></Icon>,
            Eye: (p) => <Icon {...p}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>,
            AlertTriangle: (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></Icon>,
            Lock: (p) => <Icon {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>,
            Link: (p) => <Icon {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></Icon>,
            RotateCcw: (p) => <Icon {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 5v7h7"/></Icon>,
            EyeOff: (p) => <Icon {...p}><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></Icon>
        };

        const parseCSV = (str) => {
            const arr = [];
            let quote = false;
            let col = 0, row = 0;
            arr[row] = arr[row] || [];
            arr[row][col] = arr[row][col] || '';
            for (let c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];
                if (cc === '"' && quote && nc === '"') { arr[row][col] += cc; ++c; continue; }
                if (cc === '"') { quote = !quote; continue; }
                if (cc === ',' && !quote) { ++col; arr[row][col] = ''; continue; }
                if (cc === '\r' && nc === '\n' && !quote) { ++row; col = 0; ++c; arr[row] = []; continue; }
                if (cc === '\n' && !quote) { ++row; col = 0; arr[row] = []; continue; }
                if (cc === '\r' && !quote) { ++row; col = 0; arr[row] = []; continue; }
                arr[row][col] += cc;
            }
            return arr;
        };

        // [MODIFIED] Added timestamp to prevent caching
        const extractGid = (input) => {
            if (!input) return '';
            try {
                if (/^\d+$/.test(input)) return input;
                const url = new URL(input);
                return url.searchParams.get('gid') || input;
            } catch (e) {
                const match = input.match(/gid=(\d+)/);
                return (match && match[1]) ? match[1] : input;
            }
        };
        
        // [MODIFIED] Updated getGvizUrl to include timestamp
        const getGvizUrl = (sId, gid) => `https://docs.google.com/spreadsheets/d/${sId}/gviz/tq?tqx=out:csv&gid=${gid}&t=${Date.now()}`;

        const parseCurrency = (str) => {
            if (!str) return 0;
            if (typeof str !== 'string' && typeof str !== 'number') return 0;
            const s = String(str).trim();
            if (s.startsWith('#')) return 0; 
            const cleanStr = s.replace(/[^0-9.-]/g, '');
            const num = parseFloat(cleanStr);
            return isNaN(num) ? 0 : Math.floor(num);
        };

        const formatKoreanCurrency = (val) => {
            if (!val || val === 0) return '0';
            if (val >= 100000000) return `${(val / 100000000).toFixed(1)}억`;
            if (val >= 10000) return `${(val / 10000).toFixed(0)}만`;
            return val.toLocaleString();
        };

        // --- NEW: D-Day 파싱 함수 (날짜 계산 안하고 텍스트 그대로 읽음) ---
        const parseDdayInfo = (str) => {
            if (!str) return { days: 9999, label: '-' };
            const s = String(str).trim().toUpperCase();

            // 1. "D-Day", "D-5", "D-13", "D+3" 등 D-Day 형식 텍스트 그대로 인식
            
            // D-Day (당일)
            if (s === 'D-DAY' || s === 'D-0') {
                return { days: 0, label: 'D-Day' };
            }

            // D-XX (남은 날짜)
            const dMinus = s.match(/D\s*-\s*(\d+)/);
            if (dMinus) {
                const days = parseInt(dMinus[1]);
                return { days: days, label: `D-${days}` };
            }

            // D+XX (마감 지남)
            const dPlus = s.match(/D\s*\+\s*(\d+)/);
            if (dPlus) {
                return { days: -parseInt(dPlus[1]), label: '마감' };
            }

            // "마감" 텍스트
            if (s.includes('마감')) {
                return { days: -1, label: '마감' };
            }

            // 2. 만약 날짜 형식이면 (혹시 몰라 남겨둠 - 거의 안 쓰일 듯)
            const date = parseDateString(s);
            if (date) {
                const today = new Date();
                today.setHours(0,0,0,0);
                date.setHours(0,0,0,0);
                const diff = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
                const label = diff < 0 ? "마감" : (diff === 0 ? "D-Day" : `D-${diff}`);
                return { days: diff, label: label };
            }

            // 3. 알 수 없는 형식
            return { days: 9999, label: s };
        };

        // 기존 날짜 파서 (백업용)
        const parseDateString = (dateStr) => {
            if (!dateStr) return null;
            const s = String(dateStr).trim();
            if (!s || s === 'undefined' || s === 'null') return null;
            let y, m, d;
            const partsMatch = s.match(/(\d{2,4})[\.\-\/년\s]+(\d{1,2})[\.\-\/월\s]+(\d{1,2})/);
            if (partsMatch) { y = parseInt(partsMatch[1]); m = parseInt(partsMatch[2]) - 1; d = parseInt(partsMatch[3]); } 
            else {
                const numericMatch8 = s.match(/(20\d{2})(\d{2})(\d{2})/);
                if (numericMatch8) { y = parseInt(numericMatch8[1]); m = parseInt(numericMatch8[2]) - 1; d = parseInt(numericMatch8[3]); } 
                else {
                    const numericMatch6 = s.match(/(\d{2})(\d{2})(\d{2})/);
                    if (numericMatch6) { y = parseInt(numericMatch6[1]) + 2000; m = parseInt(numericMatch6[2]) - 1; d = parseInt(numericMatch6[3]); } 
                    else {
                        const date = new Date(s);
                        if (!isNaN(date.getTime()) && date.getFullYear() > 1900) return date;
                        return null;
                    }
                }
            }
            if (y < 100) y += 2000;
            const date = new Date(y, m, d);
            if (isNaN(date.getTime()) || y < 2000 || y > 2100) return null;
            return date;
        };

        const normalizeMonth = (str) => {
            if (!str) return '';
            let s = String(str).trim();
            if (s.startsWith('#') || s === '') return '';
            const ymdMatch = s.match(/(\d{4})[.\-/년]\s*(\d{1,2})/);
            if (ymdMatch) return `${ymdMatch[1]}-${ymdMatch[2].padStart(2, '0')}`;
            const monthMatch = s.match(/^(\d{1,2})(월)?$/);
            if (monthMatch) { const m = parseInt(monthMatch[1]); if (m >= 1 && m <= 12) return `2025-${String(m).padStart(2, '0')}`; }
            return s; 
        };

        const getItemId = (item) => item.title; 

        const CHART_COLORS = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899', '#6366f1', '#14b8a6', '#f43f5e'];

        // --- MOCK DATA ---
        const MOCK_SALES = []; 
        const MOCK_ACTIVITY = [{person:'김철수',type:'아웃바운드'},{person:'이영희',type:'메일 영업'}];
        const MOCK_TARGETS = [
            ['1월','100000000'], ['2월','100000000'], ['3월','150000000'], ['4월','150000000'], ['5월','150000000'], ['6월','150000000'],
            ['7월','200000000'], ['8월','200000000'], ['9월','200000000'], ['10월','200000000'], ['11월','200000000'], ['12월','200000000']
        ];
        
        const MOCK_NARA = [
            {title:'(테스트) 긴급 공고 - D-2', date: 'D-2', agency:'조달청', url:''},
            {title:'(테스트) 일반 공고 - D-13', date: 'D-13', agency:'한국전력', url:''}
        ].map(item => { const info = parseDdayInfo(item.date); return { ...item, dday: info.label, daysRemaining: info.days, isDeleted: false }; });

        const MOCK_SUPPORT = [
            {title:'(테스트) 긴급 지원사업 - D-Day', date: 'D-Day', agency:'중기부', url:''}
        ].map(item => { const info = parseDdayInfo(item.date); return { ...item, status: info.label, daysRemaining: info.days, color: 'red', isDeleted: false }; });

        // --- Data Editor ---
        const DataEditor = ({ activityData, salesData, targetData, colMap, onSave, onClose }) => {
            const [activeTab, setActiveTab] = useState('sales');
            const [localActivity, setLocalActivity] = useState([...activityData]);
            const [localSales, setLocalSales] = useState([...salesData]);
            const [localTargets, setLocalTargets] = useState([...targetData]);

            // Handlers
            const updateActivity = (idx, field, val) => { const n=[...localActivity]; n[idx]={...n[idx],[field]:val}; setLocalActivity(n); };
            const addActivity = () => setLocalActivity([...localActivity, {person:'', type:''}]);
            const removeActivity = (idx) => setLocalActivity(localActivity.filter((_,i)=>i!==idx));
            const updateSales = (idx, colIdx, val) => { const n=[...localSales]; while(n[idx].length<=colIdx)n[idx].push(''); n[idx][colIdx]=val; setLocalSales(n); };
            const addSales = () => { const n=[]; for(let i=0;i<=Math.max(colMap.revenue,7);i++)n.push(''); n[colMap.date]=new Date().toISOString().slice(0,7); setLocalSales([...localSales,n]); };
            const removeSales = (idx) => setLocalSales(localSales.filter((_,i)=>i!==idx));
            const updateTarget = (idx, colIdx, val) => { const n=[...localTargets]; while(n[idx].length<=colIdx)n[idx].push(''); n[idx][colIdx]=val; setLocalTargets(n); };
            const addTarget = () => setLocalTargets([...localTargets, ['','']]);
            const removeTarget = (idx) => setLocalTargets(localTargets.filter((_,i)=>i!==idx));
            const handleSave = () => onSave(localActivity, localSales, localTargets);

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] backdrop-blur-sm p-4">
                    <div className="bg-slate-800 w-full max-w-4xl h-[80vh] rounded-lg shadow-2xl flex flex-col border border-slate-600">
                        <div className="flex justify-between items-center p-3 border-b border-slate-700 bg-slate-900/50 rounded-t-lg">
                            <div className="flex items-center gap-2"><Icons.Edit className="text-blue-400" /><h2 className="text-lg font-bold text-white">데이터 편집 모드</h2></div>
                            <button onClick={onClose}><Icons.X className="text-slate-400 hover:text-white" /></button>
                        </div>
                        <div className="flex border-b border-slate-700 bg-slate-900/30">
                            <button onClick={()=>setActiveTab('sales')} className={`px-4 py-3 text-sm font-bold flex items-center gap-2 ${activeTab==='sales'?'text-emerald-400 border-b-2 border-emerald-400 bg-slate-800':'text-slate-400'}`}><Icons.DollarSign size={14}/> Sales</button>
                            <button onClick={()=>setActiveTab('activity')} className={`px-4 py-3 text-sm font-bold flex items-center gap-2 ${activeTab==='activity'?'text-blue-400 border-b-2 border-blue-400 bg-slate-800':'text-slate-400'}`}><Icons.Briefcase size={14}/> Activity</button>
                            <button onClick={()=>setActiveTab('target')} className={`px-4 py-3 text-sm font-bold flex items-center gap-2 ${activeTab==='target'?'text-slate-200 border-b-2 border-slate-400 bg-slate-800':'text-slate-400'}`}><Icons.Target size={14}/> Target</button>
                        </div>
                        <div className="flex-1 overflow-auto p-4 bg-slate-800 text-white">
                            {/* Editor Tables */}
                            {activeTab === 'sales' && (<div><table className="w-full text-sm text-left text-slate-400"><thead className="text-xs uppercase bg-slate-700 text-slate-200 sticky top-0"><tr><th className="px-3 py-2 w-24">날짜</th><th className="px-3 py-2">담당자</th><th className="px-3 py-2 w-32">매출액</th><th className="px-3 py-2 w-16">삭제</th></tr></thead><tbody className="divide-y divide-slate-700">{localSales.map((r,i)=>(<tr key={i}><td className="p-1"><input className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white" value={r[colMap.date]||''} onChange={e=>updateSales(i,colMap.date,e.target.value)}/></td><td className="p-1"><input className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white" value={r[colMap.manager]||''} onChange={e=>updateSales(i,colMap.manager,e.target.value)}/></td><td className="p-1"><input className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white text-right" value={r[colMap.revenue]||''} onChange={e=>updateSales(i,colMap.revenue,e.target.value)}/></td><td className="p-1 text-center"><button onClick={()=>removeSales(i)}><Icons.Trash className="text-red-400"/></button></td></tr>))}</tbody></table><button onClick={addSales} className="mt-3 flex items-center gap-1 text-xs text-emerald-400 font-bold px-2 py-1 border border-emerald-900 bg-emerald-900/20 rounded"><Icons.Plus size={12}/> 행 추가</button></div>)}
                            {activeTab === 'activity' && (<div><table className="w-full text-sm text-left text-slate-400"><thead className="text-xs uppercase bg-slate-700 text-slate-200 sticky top-0"><tr><th className="px-3 py-2">담당자</th><th className="px-3 py-2">활동 유형</th><th className="px-3 py-2 w-16">삭제</th></tr></thead><tbody className="divide-y divide-slate-700">{localActivity.map((r,i)=>(<tr key={i}><td className="p-1"><input className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white" value={r.person||''} onChange={e=>updateActivity(i,'person',e.target.value)}/></td><td className="p-1"><input className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white" value={r.type||''} onChange={e=>updateActivity(i,'type',e.target.value)}/></td><td className="p-1 text-center"><button onClick={()=>removeActivity(i)}><Icons.Trash className="text-red-400"/></button></td></tr>))}</tbody></table><button onClick={addActivity} className="mt-3 flex items-center gap-1 text-xs text-blue-400 font-bold px-2 py-1 border border-blue-900 bg-blue-900/20 rounded"><Icons.Plus size={12}/> 행 추가</button></div>)}
                            {activeTab === 'target' && (<div><table className="w-full text-sm text-left text-slate-400"><thead className="text-xs uppercase bg-slate-700 text-slate-200 sticky top-0"><tr><th className="px-3 py-2">월</th><th className="px-3 py-2">목표 금액</th><th className="px-3 py-2 w-16">삭제</th></tr></thead><tbody className="divide-y divide-slate-700">{localTargets.map((r,i)=>(<tr key={i}><td className="p-1"><input className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white" value={r[0]||''} onChange={e=>updateTarget(i,0,e.target.value)}/></td><td className="p-1"><input className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white text-right" value={r[1]||''} onChange={e=>updateTarget(i,1,e.target.value)}/></td><td className="p-1 text-center"><button onClick={()=>removeTarget(i)}><Icons.Trash className="text-red-400"/></button></td></tr>))}</tbody></table><button onClick={addTarget} className="mt-3 flex items-center gap-1 text-xs text-slate-400 font-bold px-2 py-1 border border-slate-700 bg-slate-800 rounded"><Icons.Plus size={12}/> 행 추가</button></div>)}
                        </div>
                        <div className="p-3 border-t border-slate-700 bg-slate-900/50 rounded-b-lg flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded text-xs font-bold">취소</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-bold flex items-center gap-2 shadow-lg"><Icons.Save size={14}/> 저장 및 적용</button>
                        </div>
                    </div>
                </div>
            );
        };

        function SalesDashboard() {
            // ... existing state ...
            const [activityData, setActivityData] = useState(MOCK_ACTIVITY);
            const [salesData, setSalesData] = useState(MOCK_SALES);
            const [targetData, setTargetData] = useState(MOCK_TARGETS);
            const [naraData, setNaraData] = useState(MOCK_NARA);
            const [supportData, setSupportData] = useState(MOCK_SUPPORT);
            const [isLiveSource, setIsLiveSource] = useState(false);
            const [isManual, setIsManual] = useState(false);
            const [rawSales, setRawSales] = useState([]);
            const [rawNara, setRawNara] = useState([]);
            const [loading, setLoading] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showEditor, setShowEditor] = useState(false);
            const [showRawInspector, setShowRawInspector] = useState(false);
            const [showTrash, setShowTrash] = useState(false);

            // [NEW] Default Script URL from User
            const [scriptUrl, setScriptUrl] = useState('https://script.google.com/macros/s/AKfycbxgDywkmeNjsVGAJP_HbhJiwILb64Uq7g-TEs90q7dpCTZCSvcya8-pHJYRt_Ibijg/exec');

            // IDs
            const [salesSheetId, setSalesSheetId] = useState('1W0OXOMzCvq6KlBwWpnnXQTgcOaC1gK4zftTEq5qmfns'); 
            const [naraSheetId, setNaraSheetId] = useState('1rQDHHcClFD2VVkq7xfXsk8oO7UVDMATiHdz1qZTMPeQ');
            // [NEW] Trash Sheet ID
            const [trashSheetId, setTrashSheetId] = useState('1syF1EYKS2Vv5eLXN5edcUlBCyKFCW1ZNflUa5VidSbI');

            const [activityGid, setActivityGid] = useState('0');
            const [salesGid, setSalesGid] = useState('1883872851');
            const [naraGid, setNaraGid] = useState('342497810'); 
            const [supportGid, setSupportGid] = useState('296122045');
            
            const [actColMap, setActColMap] = useState({ name: 2, type: 3 });
            const [colMap, setColMap] = useState({ date: 0, manager: 2, client: 3, count: 4, revenue: 7 });
            
            // [FIXED] Updated default URL column index to 5 (Column F) for both
            const [naraColMap, setNaraColMap] = useState({ title: 0, date: 1, agency: 2, url: 5, trash: 7 });
            const [supportColMap, setSupportColMap] = useState({ title: 0, date: 1, agency: 2, url: 5, trash: 7 });

            // Layout State
            const [layout, setLayout] = useState({
                leftWidth: 25, // % for activity
                rightRow1Height: 22, // % for Revenue/Top3
                rightRow2Height: 26, // % for Target
                row1Split: 50 // % for Revenue vs Top 3 split
            });
            const [isResizing, setIsResizing] = useState(false);
            const mainContainerRef = useRef(null);
            const rightContainerRef = useRef(null);
            const row1ContainerRef = useRef(null);

            const startResize = (type, e) => {
                e.preventDefault();
                e.stopPropagation(); // prevent bubbling issues
                setIsResizing(true);
                const startX = e.clientX;
                const startY = e.clientY;
                const startLayout = { ...layout };

                const doResize = (moveEvent) => {
                    if (type === 'main-vertical' && mainContainerRef.current) {
                        const containerW = mainContainerRef.current.offsetWidth;
                        const deltaX = moveEvent.clientX - startX;
                        const deltaPercent = (deltaX / containerW) * 100;
                        setLayout(prev => ({...prev, leftWidth: Math.max(10, Math.min(50, startLayout.leftWidth + deltaPercent))}));
                    } else if (type === 'row1-height' && rightContainerRef.current) {
                        const containerH = rightContainerRef.current.offsetHeight;
                        const deltaY = moveEvent.clientY - startY;
                        const deltaPercent = (deltaY / containerH) * 100;
                        setLayout(prev => ({...prev, rightRow1Height: Math.max(10, Math.min(60, startLayout.rightRow1Height + deltaPercent))}));
                    } else if (type === 'row2-height' && rightContainerRef.current) {
                        const containerH = rightContainerRef.current.offsetHeight;
                        const deltaY = moveEvent.clientY - startY;
                        const deltaPercent = (deltaY / containerH) * 100;
                        setLayout(prev => ({...prev, rightRow2Height: Math.max(10, Math.min(60, startLayout.rightRow2Height + deltaPercent))}));
                    } else if (type === 'row1-split' && row1ContainerRef.current) {
                        const containerW = row1ContainerRef.current.offsetWidth;
                        const deltaX = moveEvent.clientX - startX;
                        const deltaPercent = (deltaX / containerW) * 100;
                        setLayout(prev => ({...prev, row1Split: Math.max(20, Math.min(80, startLayout.row1Split + deltaPercent))}));
                    }
                };

                const stopResize = () => {
                    setIsResizing(false);
                    document.removeEventListener('mousemove', doResize);
                    document.removeEventListener('mouseup', stopResize);
                };

                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
            };

            const getGvizUrl = (sId, gid) => `https://docs.google.com/spreadsheets/d/${sId}/gviz/tq?tqx=out:csv&gid=${gid}&t=${Date.now()}`;

            const handleTrashAction = async (title, type, action) => {
                if (!scriptUrl) {
                    alert("⚠️ 중요: 삭제 버튼을 작동시키려면 '공유 휴지통(Web App) URL' 설정이 필요합니다.\n\n제가 제공해드린 Apps Script 코드를 [휴지통 스프레드시트] > [확장 프로그램] > [Apps Script]에 복사하고 배포한 URL을 설정 메뉴에 입력해주세요.");
                    return;
                }
                const updateLocalData = (dataSetter) => {
                    dataSetter(prev => prev.map(item => {
                        if (item.title === title) {
                            return { ...item, isDeleted: action === 'delete' };
                        }
                        return item;
                    }));
                };
                if (type === '나라장터') updateLocalData(setNaraData);
                else updateLocalData(setSupportData);
                try {
                    await fetch(scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ title, type, action })
                    });
                } catch (e) {
                    console.error("Trash Sync Error:", e);
                    alert("서버 동기화 실패. URL을 확인하세요.");
                }
            };

            const fetchAndParse = async (url) => {
                try {
                    const res = await fetch(url);
                    const text = await res.text();
                    if (res.ok && !text.trim().startsWith('<')) {
                        const rows = parseCSV(text);
                        if (rows.length < 2) return null; 
                        return rows;
                    }
                } catch(e) { }
                return null;
            };

            const fetchData = useCallback(async () => {
                if (isManual) return;
                setLoading(true);
                let successCount = 0;

                const actRows = await fetchAndParse(getGvizUrl(salesSheetId, activityGid));
                if (actRows) {
                    const parsed = actRows.slice(1).map(r => ({ person: r[actColMap.name], type: r[actColMap.type] })).filter(r => r.person);
                    if(parsed.length > 0) { setActivityData(parsed); successCount++; }
                }

                const salesRows = await fetchAndParse(getGvizUrl(salesSheetId, salesGid));
                if (salesRows) {
                    setRawSales(salesRows.slice(0, 5));
                    if (salesRows.length > 1) { setSalesData(salesRows.slice(1)); successCount++; }
                }
                
                // [NEW] Fetch Trash Data First (Try Script URL first, then fallback to GViz)
                let deletedSet = new Set();
                let trashLoaded = false;

                if (scriptUrl) {
                    try {
                        const res = await fetch(scriptUrl + '?action=read&no_cache=' + Date.now()); 
                        if (res.ok) {
                            const json = await res.json();
                            if (json.status === 'success' && Array.isArray(json.data)) {
                                json.data.forEach(t => deletedSet.add(String(t).trim()));
                                trashLoaded = true;
                                console.log("Trash loaded from Script:", deletedSet.size);
                            }
                        }
                    } catch (e) {
                        console.log("Script fetch failed, falling back to GViz", e);
                    }
                }

                if (!trashLoaded && trashSheetId) {
                     const trashRows = await fetchAndParse(getGvizUrl(trashSheetId, '0'));
                     if (trashRows && trashRows.length > 0) {
                         trashRows.forEach(r => {
                             if(r[0]) deletedSet.add(String(r[0]).trim());
                         });
                         console.log("Trash loaded from GViz:", deletedSet.size);
                     }
                }

                if (naraGid) {
                    const cleanGid = extractGid(naraGid);
                    const naraRows = await fetchAndParse(getGvizUrl(naraSheetId, cleanGid));
                    if (naraRows && naraRows.length > 1) {
                        setRawNara(naraRows.slice(0, 3)); 
                        const parsedNara = naraRows.slice(1).map(r => {
                            let rawTitle = r[naraColMap.title] || '';
                            let title = String(rawTitle).replace(/^undefinedv?/, '').trim();
                            
                            // [FIXED] Use parseDdayInfo with naraColMap
                            let dateRaw = r[naraColMap.date];
                            let info = parseDdayInfo(dateRaw);
                            
                            if (info.days === 9999) {
                                // Fallback search in other columns
                                for(let i=0; i<r.length; i++) {
                                    if(i === naraColMap.title || i === naraColMap.agency) continue; 
                                    const fallbackInfo = parseDdayInfo(r[i]);
                                    if(fallbackInfo.days !== 9999) {
                                        info = fallbackInfo;
                                        break;
                                    }
                                }
                            }

                            const isDeleted = deletedSet.has(title);

                            return {
                                title: title,
                                dday: info.label,
                                daysRemaining: info.days,
                                agency: r[naraColMap.agency] || '',
                                url: r[naraColMap.url] || '',
                                isDeleted: isDeleted
                            };
                        }).filter(r => r.title);
                        if (parsedNara.length > 0) setNaraData(parsedNara);
                    }
                }

                if (supportGid) {
                    const cleanGid = extractGid(supportGid);
                    const supportRows = await fetchAndParse(getGvizUrl(naraSheetId, cleanGid));
                    if (supportRows && supportRows.length > 1) {
                        const parsedSupport = supportRows.slice(1).map(r => {
                            let rawTitle = r[naraColMap.title] || ''; // Use naraColMap for shared config
                            let title = String(rawTitle).replace(/^undefinedv?/, '').trim();
                            
                            // [FIXED] Use parseDdayInfo with naraColMap
                            let dateRaw = r[naraColMap.date]; // Use naraColMap for shared config
                            let info = parseDdayInfo(dateRaw);
                            
                            if (info.days === 9999) {
                                for(let i=0; i<r.length; i++) {
                                    if(i === naraColMap.title || i === naraColMap.agency) continue; // Use naraColMap for shared config
                                    const fallbackInfo = parseDdayInfo(r[i]);
                                    if(fallbackInfo.days !== 9999) {
                                        info = fallbackInfo;
                                        break;
                                    }
                                }
                            }

                            const isDeleted = deletedSet.has(title);

                            return {
                                title: title,
                                status: info.label,
                                daysRemaining: info.days,
                                color: info.days <= 5 && info.days >= 0 ? 'red' : 'emerald',
                                agency: r[naraColMap.agency] || '', // Use naraColMap for shared config
                                url: r[naraColMap.url] || '', // Use naraColMap for shared config
                                isDeleted: isDeleted
                            };
                        }).filter(r => r.title);
                        if (parsedSupport.length > 0) setSupportData(parsedSupport);
                    }
                }

                setIsLiveSource(successCount > 0);
                setLoading(false);
            }, [salesSheetId, naraSheetId, trashSheetId, activityGid, salesGid, actColMap, colMap, naraColMap, isManual, naraGid, supportGid, scriptUrl]); // Added scriptUrl to deps

            useEffect(() => { fetchData(); const t = setInterval(fetchData, 600000); return () => clearInterval(t); }, [fetchData]);

            const handleApplySettings = () => { setTimeout(() => { fetchData(); setShowSettings(false); }, 100); };
            const handleEditorSave = (a, s, t) => { setActivityData(a); setSalesData(s); setTargetData(t); setShowEditor(false); setIsLiveSource(true); setIsManual(true); };
            const resetToAuto = () => { if(confirm("수기 입력을 취소하고 구글 시트 데이터로 되돌리시겠습니까?")) { setIsManual(false); fetchData(); } };
            
            const safeActivity = useMemo(() => (activityData && activityData.length > 0) ? activityData : MOCK_ACTIVITY, [activityData]);
            const safeSales = useMemo(() => (salesData && salesData.length > 0) ? salesData : MOCK_SALES, [salesData]);
            const safeTargets = useMemo(() => (targetData && targetData.length > 0) ? targetData : MOCK_TARGETS, [targetData]);
            const safeNara = useMemo(() => (naraData && naraData.length > 0) ? naraData : MOCK_NARA, [naraData]);
            const safeSupport = useMemo(() => (supportData && supportData.length > 0) ? supportData : MOCK_SUPPORT, [supportData]);

            // 정렬 로직 수정: daysRemaining 기준 (작은게 위로, 음수/마감은 아래로)
            const sortData = (data) => {
                return [...data].sort((a, b) => {
                    // 파싱 실패(9999) 처리: 맨 뒤로
                    if (a.daysRemaining === 9999) return 1;
                    if (b.daysRemaining === 9999) return -1;

                    const aActive = a.daysRemaining >= 0;
                    const bActive = b.daysRemaining >= 0;

                    // 둘 다 진행 중 (0 이상) -> 임박한 순 (작은 숫자)
                    if (aActive && bActive) return a.daysRemaining - b.daysRemaining;
                    
                    // a만 진행 중 -> a 위로
                    if (aActive && !bActive) return -1;
                    
                    // b만 진행 중 -> b 위로
                    if (!aActive && bActive) return 1;

                    // 둘 다 마감됨 (음수) -> 덜 오래된 마감(큰 음수)이 위로? 혹은 그냥 둠
                    // 여기서는 "최근 마감"이 위로 오게 처리 (예: -1 > -5)
                    return b.daysRemaining - a.daysRemaining;
                });
            };

            const visibleNara = useMemo(() => {
                const filtered = safeNara.filter(item => showTrash ? item.isDeleted : !item.isDeleted);
                return sortData(filtered);
            }, [safeNara, showTrash]);

            const visibleSupport = useMemo(() => {
                const filtered = safeSupport.filter(item => showTrash ? item.isDeleted : !item.isDeleted);
                return sortData(filtered);
            }, [safeSupport, showTrash]);

            const processedActivityGroups = useMemo(() => {
                const groups = {};
                safeActivity.forEach(item => {
                    if (!item || !item.person || !item.type) return;
                    const t = item.type.trim();
                    if (!groups[t]) groups[t] = {};
                    groups[t][item.person] = (groups[t][item.person] || 0) + 1;
                });
                return Object.keys(groups).map(type => {
                    const data = Object.entries(groups[type]).map(([name, count]) => ({ 
                        name, count, target: Math.ceil(count * 6.25)
                    })).sort((a, b) => b.count - a.count);
                    const totalCount = data.reduce((a, c) => a + c.count, 0);
                    return { type, data, totalCount };
                }).filter(g => g.totalCount > 0).sort((a, b) => b.totalCount - a.totalCount);
            }, [safeActivity]);

            const processedSales = useMemo(() => {
                const aggregated = {};
                safeSales.forEach(row => {
                    if (!row) return;
                    const manager = row[colMap.manager];
                    const rev = parseCurrency(row[colMap.revenue]);
                    if (!manager) return;
                    if (!aggregated[manager]) aggregated[manager] = { 담당자: manager, 매출액: 0 };
                    aggregated[manager].매출액 += rev;
                });
                return Object.values(aggregated);
            }, [safeSales, colMap]);

            const processedMonthly = useMemo(() => {
                const dataMap = new Map();
                for (let i = 1; i <= 12; i++) {
                    const k = `2025-${String(i).padStart(2, '0')}`;
                    dataMap.set(k, { month: k, target: 0, revenue: 0, rate: 0 });
                }
                safeTargets.forEach(row => {
                    if (!row || row.length < 2) return;
                    const k = normalizeMonth(row[0]);
                    if(k && dataMap.has(k)) dataMap.get(k).target = parseCurrency(row[1]);
                });
                safeSales.forEach(row => {
                    if (!row) return;
                    const k = normalizeMonth(row[colMap.date]);
                    if (k && dataMap.has(k)) dataMap.get(k).revenue += parseCurrency(row[colMap.revenue]);
                });
                return Array.from(dataMap.values()).sort((a, b) => a.month.localeCompare(b.month)).map(d => ({ ...d, rate: d.target > 0 ? (d.revenue / d.target * 100) : 0 }));
            }, [safeTargets, safeSales, colMap]);

            const chartData = useMemo(() => processedSales.filter(d => d.매출액 > 0), [processedSales]);
            const topSales = useMemo(() => [...processedSales].filter(d => d.매출액 > 0).sort((a, b) => b.매출액 - a.매출액).slice(0, 3), [processedSales]);
            const totalRevenue = useMemo(() => processedSales.reduce((acc, curr) => acc + curr.매출액, 0), [processedSales]);
            const totalTarget = useMemo(() => processedMonthly.reduce((acc, curr) => acc + curr.target, 0), [processedMonthly]);

            const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LabelList, Legend, Cell } = window.Recharts;
            
            return (
                <div className={`h-full w-full flex flex-col overflow-hidden text-slate-100 font-sans bg-slate-900 fade-in ${isResizing ? 'select-none' : ''}`}>
                    {/* Header */}
                    <div className="h-12 bg-slate-800 border-b border-slate-700 px-4 flex items-center justify-between shrink-0">
                        <div className="flex items-center gap-3"><Icons.LayoutDashboard size={20} className="text-blue-500" /><h1 className="text-lg font-bold text-white tracking-wide">Sales Command Center</h1></div>
                        <div className="flex items-center gap-3">
                            <span className="text-xs text-slate-400 mr-2 hidden sm:block font-medium">자동 업데이트: 매일 18:10</span>
                            <div className={`flex items-center gap-1 px-2 py-1 rounded text-xs font-bold border ${isManual ? 'bg-blue-600/20 border-blue-500/50 text-blue-400' : (isLiveSource ? 'bg-emerald-600/20 border-emerald-500/50 text-emerald-400' : 'bg-amber-600/20 border-amber-500/50 text-amber-400')}`}>
                                {isManual ? <Icons.Lock size={14}/> : (isLiveSource ? <Icons.Check size={14}/> : <Icons.AlertTriangle size={14}/>)}
                                {isManual ? '수기 모드 (잠금)' : (isLiveSource ? 'Live Data' : 'Check Source')}
                            </div>
                            {isManual && <button onClick={resetToAuto} className="text-xs text-slate-400 hover:text-white underline mr-2">수동 해제</button>}
                            <button onClick={()=>setShowEditor(true)} className="flex items-center gap-1 text-slate-300 hover:text-white px-2 py-1 hover:bg-slate-700 rounded transition-colors"><Icons.Edit size={16} /><span className="text-xs font-bold">수정</span></button>
                            <button onClick={()=>setShowSettings(!showSettings)} className="text-slate-300 hover:text-white p-1 hover:bg-slate-700 rounded"><Icons.Settings size={18} /></button>
                            <button onClick={fetchData} className={`text-slate-300 hover:text-white p-1 hover:bg-slate-700 rounded ${loading?'animate-spin':''}`}><Icons.RefreshCw size={18} /></button>
                        </div>
                    </div>

                    {showEditor && <DataEditor activityData={activityData} salesData={salesData} targetData={targetData} colMap={colMap} onSave={handleEditorSave} onClose={() => setShowEditor(false)} />}

                    {/* Settings Panel */}
                    {showSettings && (
                        <div className="absolute top-14 right-4 z-50 w-[500px] bg-slate-800 border border-slate-600 rounded shadow-2xl p-4 text-sm slide-in flex flex-col max-h-[80vh] overflow-hidden">
                            <div className="flex justify-between mb-3 shrink-0"><span className="font-bold text-base text-white">데이터 설정</span><button onClick={() => setShowSettings(false)}><Icons.X size={18}/></button></div>
                            <div className="flex gap-2 mb-3 shrink-0 border-b border-slate-700 pb-2"><button onClick={()=>setShowRawInspector(false)} className={`px-3 py-1 rounded ${!showRawInspector ? 'bg-blue-600 text-white' : 'text-slate-400'}`}>매핑 설정</button><button onClick={()=>setShowRawInspector(true)} className={`px-3 py-1 rounded flex items-center gap-1 ${showRawInspector ? 'bg-blue-600 text-white' : 'text-slate-400'}`}><Icons.Eye size={12}/> 데이터 미리보기</button></div>
                            <div className="flex-1 overflow-auto">
                                {!showRawInspector ? (
                                    <>
                                        <div className="mb-3 p-2 bg-indigo-900/30 border border-indigo-700 rounded">
                                            <label className="block text-indigo-300 text-xs mb-1 font-bold">공유 휴지통(Web App) URL</label>
                                            <input type="text" value={scriptUrl} onChange={(e) => setScriptUrl(e.target.value)} placeholder="Apps Script 배포 URL (https://script.google.com/...)" className="w-full bg-slate-900 border border-indigo-500 rounded px-2 py-2 text-white" />
                                            <p className="text-[10px] text-slate-400 mt-1">* ⚠️ 중요: 삭제 버튼을 사용하려면 제공된 Apps Script를 휴지통 시트에 설치하고 배포한 주소를 여기에 입력하세요.</p>
                                        </div>
                                        <div className="mb-3"><label className="block text-slate-400 text-xs mb-1 font-bold">휴지통 시트 ID</label><input type="text" value={trashSheetId} onChange={(e) => setTrashSheetId(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-white" /></div>
                                        <div className="mb-3"><label className="block text-emerald-400 text-xs mb-1 font-bold">매출/활동 시트 ID</label><input type="text" value={salesSheetId} onChange={(e) => setSalesSheetId(e.target.value)} className="w-full bg-slate-900 border border-emerald-600 rounded px-2 py-2 text-white" /></div>
                                        <div className="my-3 border-t border-slate-700 pt-3"><h4 className="text-indigo-400 font-bold mb-2 text-xs">나라장터 / 지원사업 설정</h4>
                                            <div className="mb-3"><label className="block text-emerald-400 text-xs mb-1 font-bold">공고/지원 시트 ID</label><input type="text" value={naraSheetId} onChange={(e) => setNaraSheetId(e.target.value)} className="w-full bg-slate-900 border border-emerald-600 rounded px-2 py-2 text-white" /></div>
                                            <div className="grid grid-cols-5 gap-2 mb-3">
                                                <div><label className="text-[10px] text-slate-500">제목</label><input type="number" value={naraColMap.title} onChange={e=>setNaraColMap({...naraColMap, title:parseInt(e.target.value)})} className="w-full bg-slate-800 border border-slate-600 rounded px-1 py-1 text-white"/></div>
                                                <div><label className="text-[10px] text-slate-500">날짜</label><input type="number" value={naraColMap.date} onChange={e=>setNaraColMap({...naraColMap, date:parseInt(e.target.value)})} className="w-full bg-slate-800 border border-slate-600 rounded px-1 py-1 text-white"/></div>
                                                <div><label className="text-[10px] text-slate-500">기관</label><input type="number" value={naraColMap.agency} onChange={e=>setNaraColMap({...naraColMap, agency:parseInt(e.target.value)})} className="w-full bg-slate-800 border border-slate-600 rounded px-1 py-1 text-white"/></div>
                                                <div><label className="text-[10px] text-slate-500">URL</label><input type="number" value={naraColMap.url} onChange={e=>setNaraColMap({...naraColMap, url:parseInt(e.target.value)})} className="w-full bg-slate-800 border border-slate-600 rounded px-1 py-1 text-white"/></div>
                                            </div>
                                        </div>
                                        <button onClick={handleApplySettings} className="w-full bg-blue-600 py-2 rounded text-white font-bold text-sm hover:bg-blue-500">설정 적용</button>
                                    </>
                                ) : (
                                    <div className="space-y-4">
                                        <div><h4 className="text-emerald-400 font-bold mb-2 text-xs">Sales Data (Top 5)</h4><div className="overflow-x-auto bg-slate-900 p-2 rounded border border-slate-700"><table className="text-[10px] w-full text-left text-slate-300"><tbody>{rawSales.length > 0 ? rawSales.map((r, i) => (<tr key={i} className="border-b border-slate-800"><td className="p-1 text-slate-500">{i}</td>{r.map((c, j) => <td key={j} className="p-1 border-r border-slate-800 truncate max-w-[60px]" title={c}>{c}</td>)}</tr>)) : <tr><td className="p-2 text-slate-500">데이터 없음</td></tr>}</tbody></table></div></div>
                                        <div><h4 className="text-indigo-400 font-bold mb-2 text-xs">Nara Data (Top 3)</h4><div className="overflow-x-auto bg-slate-900 p-2 rounded border border-slate-700"><table className="text-[10px] w-full text-left text-slate-300"><tbody>{rawNara.length > 0 ? rawNara.map((r, i) => (<tr key={i} className="border-b border-slate-800"><td className="p-1 text-slate-500">{i}</td>{r.map((c, j) => <td key={j} className="p-1 border-r border-slate-800 truncate max-w-[60px]" title={c}>{c}</td>)}</tr>)) : <tr><td className="p-2 text-slate-500">데이터 없음</td></tr>}</tbody></table></div></div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Main Content Resizable Layout */}
                    <div className="flex-1 overflow-hidden p-3 flex flex-row min-h-0" ref={mainContainerRef}>
                        {/* 1. Activity (Left) */}
                        <div style={{ width: `${layout.leftWidth}%` }} className="bg-slate-800/40 border border-slate-700/50 rounded-xl p-3 flex flex-col h-full overflow-hidden shadow-lg min-h-0">
                            <div className="flex items-center gap-2 mb-2 text-blue-400 font-bold text-base shrink-0 border-b border-slate-700/50 pb-2"><Icons.Briefcase size={16}/> Daily Activities</div>
                            <div className="flex-1 flex flex-col gap-1 overflow-y-auto min-h-0">
                                {processedActivityGroups.length > 0 ? processedActivityGroups.map((g, i) => (
                                    <div key={g.type} className="flex-1 min-h-[80px] bg-slate-900/40 rounded-lg p-2 flex flex-col border border-slate-700/30">
                                        <span className="text-xs font-bold text-slate-200 flex items-center gap-2 mb-1 px-1 shrink-0"><Icons.Layers size={12} style={{color:CHART_COLORS[i%8]}}/> {g.type} <span className="text-slate-400 font-normal">[{g.totalCount}/{g.data[0]?.target || 0}]</span></span>
                                        <div className="flex-1 min-h-0">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={g.data} margin={{ top: 20, right: 10, left: -10, bottom: 0 }}>
                                                    <defs>
                                                        <linearGradient id={`activityGrad${i%8}`} x1="0" y1="0" x2="0" y2="1">
                                                            <stop offset="0%" stopColor={CHART_COLORS[i%8]} stopOpacity={0.8}/>
                                                            <stop offset="100%" stopColor={CHART_COLORS[i%8]} stopOpacity={0.4}/>
                                                        </linearGradient>
                                                    </defs>
                                                    <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                                    <XAxis dataKey="name" stroke="#94a3b8" tick={{fontSize: 11, fontWeight: 'bold', fill: '#ffffff'}} interval={0} />
                                                    <YAxis stroke="#94a3b8" tick={{fontSize: 10, fill: '#ffffff'}} />
                                                    <Tooltip cursor={{fill: '#334155', opacity: 0.2}} contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', fontSize: '11px', color: '#fff' }} />
                                                    <Bar name="실적" dataKey="count" fill={`url(#activityGrad${i%8})`} radius={[3, 3, 0, 0]} maxBarSize={30}>
                                                        <LabelList dataKey="count" content={({x,y,width,value})=>value?<text x={x+width/2} y={y-3} fill="#fff" textAnchor="middle" fontSize={11} fontWeight="bold">{value}</text>:null} />
                                                    </Bar>
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                )) : <div className="flex-1 flex items-center justify-center text-sm text-slate-500">데이터 없음</div>}
                            </div>
                        </div>

                        {/* Vertical Resizer */}
                        <div className={`resizer-v ${isResizing ? 'resizing' : ''}`} onMouseDown={(e) => startResize('main-vertical', e)}></div>

                        {/* Right Column */}
                        <div style={{ width: `${100 - layout.leftWidth}%` }} className="flex flex-col h-full min-h-0" ref={rightContainerRef}>
                            {/* Row 1: Sales & Top 3 */}
                            <div style={{ height: `${layout.rightRow1Height}%` }} className="flex flex-row min-h-0" ref={row1ContainerRef}>
                                <div style={{ width: `${layout.row1Split}%` }} className="bg-slate-800/40 border border-slate-700/50 rounded-xl p-3 flex flex-col min-h-0 shadow-lg">
                                    <div className="flex items-center gap-2 mb-1 text-emerald-400 font-bold text-base"><Icons.DollarSign size={16}/> Revenue Status <span className="text-white ml-1 text-sm truncate">[총 매출 {formatKoreanCurrency(totalRevenue)}원 / 목표 20억]</span></div>
                                    <div className="flex-1 min-h-0">
                                        {totalRevenue > 0 ? (
                                            <ResponsiveContainer width="100%" height="100%"><BarChart data={chartData.filter(d=>d.매출액>0).sort((a,b)=>b.매출액-a.매출액)} margin={{ top: 20, right: 10, left: 10, bottom: 0 }}><defs><linearGradient id="revenueStatusGrad" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#f97316" stopOpacity={0.9}/><stop offset="95%" stopColor="#ef4444" stopOpacity={0.9}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} /><XAxis dataKey="담당자" stroke="#94a3b8" tick={{fontSize: 11, fontWeight: 'bold', fill: '#ffffff'}} interval={0} /><YAxis stroke="#94a3b8" tick={{fontSize: 10, fill: '#ffffff'}} tickFormatter={v=>v>=10000?`${v/10000}만`:v} /><Tooltip cursor={{fill: '#334155', opacity: 0.2}} contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', fontSize: '11px', color: '#fff' }} formatter={(val) => val.toLocaleString()} /><Bar dataKey="매출액" fill="url(#revenueStatusGrad)" radius={[4, 4, 0, 0]} maxBarSize={80}><LabelList dataKey="매출액" position="top" fill="#fff" fontSize={11} fontWeight="bold" formatter={formatKoreanCurrency} /></Bar></BarChart></ResponsiveContainer>
                                        ) : (
                                            <div className="h-full flex flex-col items-center justify-center urgent-box border-4 rounded-xl relative overflow-hidden">
                                                <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-red-600/20 via-transparent to-transparent animate-pulse"></div>
                                                
                                                {/* 텍스트만 깔끔하게 중앙 배치 */}
                                                <p className="text-2xl font-black text-red-500 tracking-tighter drop-shadow-[0_0_10px_rgba(220,38,38,0.8)] mb-3 z-10 text-center">매출 없음!</p>

                                                {/* 긴급 문구: 사이즈 축소 및 심플화 */}
                                                <div className="bg-red-600/90 text-white px-3 py-1 rounded-full text-sm font-bold shadow-[0_0_15px_rgba(239,68,68,0.6)] z-10 flex items-center gap-2 flash-urgent border border-white/20">
                                                    <span>🚨</span> 긴급: 매출 발생 필요 <span>🚨</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                
                                {/* Vertical Resizer inside Row 1 */}
                                <div className={`resizer-v ${isResizing ? 'resizing' : ''}`} onMouseDown={(e) => startResize('row1-split', e)}></div>

                                <div style={{ width: `${100 - layout.row1Split}%` }} className="bg-slate-800/40 border border-slate-700/50 rounded-xl flex flex-col overflow-hidden shadow-lg min-h-0">
                                    <div className="h-8 px-3 flex items-center gap-2 bg-slate-700/30 border-b border-slate-700/50 text-yellow-400 font-bold text-base"><Icons.Crown size={16}/> Sales Top 3</div>
                                    <div className="flex-1 overflow-auto p-1 min-h-0">
                                        <table className="w-full text-xs text-left text-slate-300"><thead className="bg-slate-700/50 text-slate-100 sticky top-0 font-bold"><tr><th className="p-2 text-center w-12">순위</th><th className="p-2">담당자</th><th className="p-2 text-right">매출액</th></tr></thead><tbody className="divide-y divide-slate-700/30 text-sm">{topSales.map((r, i) => (<tr key={i} className="hover:bg-slate-700/30"><td className="p-2 text-center font-bold text-yellow-400">{i+1}</td><td className="p-2 text-white font-bold">{r.담당자}</td><td className="p-2 text-right font-mono text-emerald-400 font-bold">{formatKoreanCurrency(r.매출액)}</td></tr>))}{topSales.length===0 && <tr><td colSpan="3" className="p-4 text-center text-slate-500">데이터 없음</td></tr>}</tbody></table>
                                    </div>
                                </div>
                            </div>

                            {/* Horizontal Resizer 1 */}
                            <div className={`resizer-h ${isResizing ? 'resizing' : ''}`} onMouseDown={(e) => startResize('row1-height', e)}></div>

                            {/* Row 2: Target */}
                            <div style={{ height: `${layout.rightRow2Height}%` }} className="bg-slate-800/40 border border-slate-700/50 rounded-xl p-3 flex flex-col min-h-0 shadow-lg">
                                <div className="flex items-center justify-between mb-1 px-1">
                                    <div className="flex items-center gap-2 text-orange-400 font-bold text-base"><Icons.Target size={16} className="text-orange-400"/> Monthly Target Status</div>
                                    <span className="text-xs text-slate-400">단위: 원</span>
                                </div>
                                <div className="flex-1 min-h-0">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <BarChart data={processedMonthly} margin={{ top: 20, right: 10, left: 10, bottom: 5 }} barGap={-15}>
                                            <defs>
                                                <linearGradient id="targetGradient" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#22c55e" stopOpacity={1}/><stop offset="100%" stopColor="#3b82f6" stopOpacity={1}/></linearGradient>
                                                <linearGradient id="gradRed" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#f87171" stopOpacity={1}/><stop offset="100%" stopColor="#ef4444" stopOpacity={1}/></linearGradient>
                                                <linearGradient id="gradOrange" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#fbbf24" stopOpacity={1}/><stop offset="100%" stopColor="#f59e0b" stopOpacity={1}/></linearGradient>
                                                <linearGradient id="gradBlue" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor="#60a5fa" stopOpacity={1}/><stop offset="100%" stopColor="#3b82f6" stopOpacity={1}/></linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                                            <XAxis dataKey="month" stroke="#94a3b8" tick={{fontSize: 11, fill:'#ffffff'}} tickFormatter={v=>`${parseInt(v.split('-')[1])}월`} />
                                            <YAxis stroke="#94a3b8" tick={{fontSize: 10, fill:'#ffffff'}} tickFormatter={v=>v>=100000000?`${v/100000000}억`:`${v/10000}만`} />
                                            <Tooltip cursor={{fill: '#334155', opacity: 0.2}} contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', fontSize: '11px', color: '#fff' }} formatter={(val) => val.toLocaleString()} />
                                            <Legend wrapperStyle={{fontSize:'11px', paddingTop:'5px'}}/>
                                            <Bar name="목표" dataKey="target" fill="url(#targetGradient)" radius={[4, 4, 0, 0]} maxBarSize={50}>
                                                <LabelList dataKey="target" position="top" fill="#fff" fontSize={11} fontWeight="bold" formatter={(value) => value > 0 ? formatKoreanCurrency(value) : ''} />
                                            </Bar>
                                            <Bar name="매출" dataKey="revenue" radius={[4, 4, 0, 0]} maxBarSize={50}>
                                                <LabelList dataKey="revenue" position="top" fill="#fff" fontSize={11} fontWeight="bold" formatter={(value) => value > 0 ? formatKoreanCurrency(value) : ''} />
                                                {processedMonthly.map((e, i) => <Cell key={`cell-${i}`} fill={e.rate <= 30 ? "url(#gradRed)" : (e.rate <= 70 ? "url(#gradOrange)" : "url(#gradBlue)")} />)}
                                            </Bar>
                                        </BarChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>

                            {/* Horizontal Resizer 2 */}
                            <div className={`resizer-h ${isResizing ? 'resizing' : ''}`} onMouseDown={(e) => startResize('row2-height', e)}></div>

                            {/* Row 3: Nara & Support (With Trash Feature) */}
                            <div className="flex-1 bg-slate-800/40 border border-slate-700/50 rounded-xl flex flex-col overflow-hidden shadow-lg min-h-0">
                                <div className="h-10 px-4 flex items-center justify-between bg-slate-700/30 border-b border-slate-700/50 shrink-0">
                                    <div className="flex items-center gap-2 text-indigo-400 font-bold text-base">
                                        <Icons.Building size={18}/> 
                                        {showTrash ? "삭제된 공고 (복구 가능 - 공유됨)" : "나라장터 입찰 및 지원사업"}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={() => setShowTrash(!showTrash)}
                                            className={`flex items-center gap-1 text-xs px-2 py-1.5 rounded transition-colors font-bold ${showTrash ? 'bg-red-500/20 text-red-400' : 'bg-slate-700/50 text-slate-400 hover:text-white'}`}
                                            title={showTrash ? "목록으로 돌아가기" : "휴지통 보기"}
                                        >
                                            {showTrash ? <><Icons.RotateCcw size={12}/> 목록 보기</> : <><Icons.Trash size={12}/> 휴지통</>}
                                        </button>
                                        <button onClick={fetchData} className="text-xs bg-indigo-500/20 hover:bg-indigo-500/40 text-indigo-300 px-3 py-1.5 rounded transition-colors font-bold">새로고침</button>
                                    </div>
                                </div>
                                <div className="flex-1 p-4 overflow-hidden min-h-0">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 h-full min-h-0">
                                        
                                        {/* 나라장터 리스트 */}
                                        <div className={`rounded-lg p-3 border flex flex-col h-full overflow-hidden min-h-0 ${showTrash ? 'bg-red-900/10 border-red-900/30' : 'bg-slate-900/40 border-slate-700/50'}`}>
                                            <h3 className={`text-sm font-bold mb-3 border-b pb-2 shrink-0 ${showTrash ? 'text-red-300 border-red-900/30' : 'text-slate-300 border-slate-700'}`}>
                                                {showTrash ? '나라장터 (휴지통)' : '나라장터(물품/용역)'}
                                            </h3>
                                            <ul className="space-y-1 text-xs text-slate-300 flex-1 overflow-y-auto min-h-0 pr-1 custom-scrollbar">
                                                {visibleNara.map((item, i) => {
                                                    // [NEW] Highlight logic: Red if <= 5 days remaining and not expired
                                                    const isUrgent = item.daysRemaining >= 0 && item.daysRemaining <= 5;
                                                    return (
                                                    <li key={i} className={`list-item px-2 py-1 rounded border-b group relative transition-colors ${isUrgent ? 'bg-red-900/20 border-red-500/30' : 'border-slate-800/50'}`}>
                                                        <div className="flex justify-between items-center w-full">
                                                            <div className="flex flex-col overflow-hidden w-full cursor-pointer mr-2" onClick={() => item.url && window.open(item.url, '_blank')}>
                                                                <span className={`truncate flex-1 font-bold transition-colors text-xs ${isUrgent ? 'text-red-100' : 'text-slate-200 group-hover:text-blue-300'}`}>{item.title}</span>
                                                                <div className="flex items-center text-[10px] text-slate-500 mt-0">
                                                                    <span className="truncate max-w-[70%]">{item.agency}</span>
                                                                    <span className={`ml-2 font-bold whitespace-nowrap ${item.dday?.includes('마감') ? 'text-slate-500' : (isUrgent ? 'text-red-400' : 'text-amber-500')}`}>
                                                                        [{item.dday}]
                                                                    </span>
                                                                    <div className="ml-2 shrink-0" onClick={(e) => e.stopPropagation()}>
                                                                        {showTrash ? (
                                                                            <button 
                                                                                onClick={() => handleTrashAction(item.title, '나라장터', 'restore')}
                                                                                className="p-0.5 hover:bg-slate-700 rounded text-emerald-400"
                                                                                title="복구"
                                                                            >
                                                                                <Icons.RefreshCw size={14}/>
                                                                            </button>
                                                                        ) : (
                                                                            <button 
                                                                                onClick={() => handleTrashAction(item.title, '나라장터', 'delete')}
                                                                                className="delete-btn opacity-0 group-hover:opacity-100 p-0.5 hover:bg-slate-700 rounded text-slate-500 hover:text-red-400 transition-all"
                                                                                title="삭제"
                                                                            >
                                                                                <Icons.Trash size={14}/>
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </li>
                                                )})}
                                                {visibleNara.length === 0 && <li className="text-center text-slate-500 p-4">{showTrash ? "휴지통이 비었습니다." : "데이터 없음"}</li>}
                                            </ul>
                                        </div>

                                        {/* 지원사업 리스트 (업데이트됨) */}
                                        <div className={`rounded-lg p-3 border flex flex-col h-full overflow-hidden min-h-0 ${showTrash ? 'bg-red-900/10 border-red-900/30' : 'bg-slate-900/40 border-slate-700/50'}`}>
                                            <h3 className={`text-sm font-bold mb-3 border-b pb-2 shrink-0 ${showTrash ? 'text-red-300 border-red-900/30' : 'text-slate-300 border-slate-700'}`}>
                                                {showTrash ? '지원사업 (휴지통)' : '지원사업'}
                                            </h3>
                                            <ul className="space-y-1 text-xs text-slate-300 flex-1 overflow-y-auto min-h-0 pr-1 custom-scrollbar">
                                                {visibleSupport.map((item, i) => {
                                                    // [NEW] Highlight logic: Red if <= 5 days remaining and not expired
                                                    const isUrgent = item.daysRemaining >= 0 && item.daysRemaining <= 5;
                                                    return (
                                                    <li key={i} className={`list-item px-2 py-1 rounded border-b group relative transition-colors ${isUrgent ? 'bg-red-900/20 border-red-500/30' : 'border-slate-800/50'}`}>
                                                        <div className="flex justify-between items-center w-full">
                                                            <div className="flex flex-col overflow-hidden w-full cursor-pointer mr-2" onClick={() => item.url && window.open(item.url, '_blank')}>
                                                                <span className={`truncate flex-1 font-bold transition-colors text-xs ${isUrgent ? 'text-red-100' : 'text-slate-200 group-hover:text-blue-300'}`}>{item.title}</span>
                                                                <div className="flex items-center text-[10px] text-slate-500 mt-0">
                                                                    <span className="truncate max-w-[70%]">{item.agency}</span>
                                                                    <span className={`ml-2 font-bold whitespace-nowrap ${item.status?.includes('마감') ? 'text-slate-500' : (isUrgent ? 'text-red-400' : 'text-emerald-500')}`}>
                                                                        [{item.status}]
                                                                    </span>
                                                                    <div className="ml-2 shrink-0" onClick={(e) => e.stopPropagation()}>
                                                                        {showTrash ? (
                                                                            <button 
                                                                                onClick={() => handleTrashAction(item.title, '지원사업', 'restore')}
                                                                                className="p-0.5 hover:bg-slate-700 rounded text-emerald-400"
                                                                                title="복구"
                                                                            >
                                                                                <Icons.RefreshCw size={14}/>
                                                                            </button>
                                                                        ) : (
                                                                            <button 
                                                                                onClick={() => handleTrashAction(item.title, '지원사업', 'delete')}
                                                                                className="delete-btn opacity-0 group-hover:opacity-100 p-0.5 hover:bg-slate-700 rounded text-slate-500 hover:text-red-400 transition-all"
                                                                                title="삭제"
                                                                            >
                                                                                <Icons.Trash size={14}/>
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </li>
                                                )})}
                                                {visibleSupport.length === 0 && <li className="text-center text-slate-500 p-4">{showTrash ? "휴지통이 비었습니다." : "데이터 없음"}</li>}
                                            </ul>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SalesDashboard />);
    </script>
</body>
</html>
