<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Command Center - TV Fullscreen</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Prop-types -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    
    <!-- 4. Recharts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>

    <!-- 5. Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        html, body, #root {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* 전체 스크롤 방지 */
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: #f1f5f9;
        }
        
        /* TV 화면용: 스크롤바 숨기기 (기능은 유지) */
        ::-webkit-scrollbar {
            display: none;
        }
        * {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        /* 테이블 셀 안의 내용이 넘칠 때 말줄임표 처리 */
        .cell-truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div id="root" class="h-screen w-screen bg-slate-900"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- 아이콘 컴포넌트 (크기 조정 가능) ---
        const Icon = ({ children, size = 16, className = "", color = "currentColor", onClick }) => (
            <svg onClick={onClick} xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            LayoutDashboard: (p) => <Icon {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></Icon>,
            RefreshCw: (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>,
            Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
            Briefcase: (p) => <Icon {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></Icon>,
            Layers: (p) => <Icon {...p}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></Icon>,
            DollarSign: (p) => <Icon {...p}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></Icon>,
            Crown: (p) => <Icon {...p}><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></Icon>,
            Edit: (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>,
            X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
            Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
            Trash: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></Icon>,
            Save: (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>,
            Target: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></Icon>,
            Building: (p) => <Icon {...p}><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></Icon>
        };

        // --- 유틸리티 ---
        const parseCSV = (str) => {
            const arr = [];
            let quote = false;
            let col = 0, row = 0;
            arr[row] = arr[row] || [];
            arr[row][col] = arr[row][col] || '';
            for (let c = 0; c < str.length; c++) {
                let cc = str[c], nc = str[c+1];
                if (cc === '"' && quote && nc === '"') { arr[row][col] += cc; ++c; continue; }
                if (cc === '"') { quote = !quote; continue; }
                if (cc === ',' && !quote) { ++col; arr[row][col] = ''; continue; }
                if (cc === '\r' && nc === '\n' && !quote) { ++row; col = 0; ++c; arr[row] = []; continue; }
                if (cc === '\n' && !quote) { ++row; col = 0; arr[row] = []; continue; }
                if (cc === '\r' && !quote) { ++row; col = 0; arr[row] = []; continue; }
                arr[row][col] += cc;
            }
            return arr;
        };

        const extractGid = (input) => {
            if (!input) return '';
            try {
                if (/^\d+$/.test(input)) return input;
                const url = new URL(input);
                return url.searchParams.get('gid') || input;
            } catch (e) {
                const match = input.match(/gid=(\d+)/);
                return (match && match[1]) ? match[1] : input;
            }
        };

        const parseCurrency = (str) => {
            if (!str) return 0;
            const cleanStr = str.toString().replace(/[^0-9.-]/g, '');
            const num = parseFloat(cleanStr);
            return isNaN(num) ? 0 : Math.floor(num);
        };

        const formatKoreanCurrency = (val) => {
            if (!val || val === 0) return '0';
            if (val >= 100000000) return `${(val / 100000000).toFixed(1)}억`;
            if (val >= 10000) return `${(val / 10000).toFixed(0)}만`;
            return val.toLocaleString();
        };

        const CHART_COLORS = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ec4899', '#6366f1', '#14b8a6', '#f43f5e'];
        const COLORS = { revenue: '#10b981', target: '#64748b' };

        const MOCK_SALES = [[null, '2025-01', '김철수', 'A고객사', '1', null, null, '50000000']];
        const MOCK_ACTIVITY = [{ person: '김철수', type: '아웃바운드' }, { person: '이영희', type: '메일 영업' }];
        const MOCK_TARGETS = [
            ['2025-01', '80000000'],
            ['2025-02', '90000000'],
            ['2025-03', '100000000'],
            ['2025-04', '110000000'],
            ['2025-05', '120000000'],
            ['2025-06', '130000000'],
            ['2025-07', '120000000'],
            ['2025-08', '110000000'],
            ['2025-09', '120000000'],
            ['2025-10', '130000000'],
            ['2025-11', '140000000'],
            ['2025-12', '150000000']
        ];

        // Recharts Safe Wrapper
        const SafeRecharts = ({ render }) => {
            const [lib, setLib] = useState(window.Recharts);
            const [isTimeout, setIsTimeout] = useState(false);

            useEffect(() => {
                if (lib) return;
                const start = Date.now();
                const timer = setInterval(() => {
                    if (window.Recharts) {
                        setLib(window.Recharts);
                        clearInterval(timer);
                    } else if (Date.now() - start > 5000) { 
                        setIsTimeout(true);
                        clearInterval(timer);
                    }
                }, 100);
                return () => clearInterval(timer);
            }, [lib]);

            if (isTimeout) return <div className="flex h-full items-center justify-center text-xs text-red-400">차트 로드 실패 <button onClick={()=>window.location.reload()} className="ml-2 underline">새로고침</button></div>;
            if (!lib) return <div className="flex h-full items-center justify-center text-xs text-slate-500 animate-pulse">차트 로딩...</div>;
            return render(lib);
        };

        // --- Data Editor Component ---
        const DataEditor = ({ activityData, salesData, colMap, onSave, onClose }) => {
            const [activeTab, setActiveTab] = useState('activity');
            const [localActivity, setLocalActivity] = useState([...activityData]);
            const [localSales, setLocalSales] = useState([...salesData]);

            const updateActivity = (idx, field, val) => {
                const newData = [...localActivity];
                newData[idx] = { ...newData[idx], [field]: val };
                setLocalActivity(newData);
            };
            const addActivity = () => setLocalActivity([...localActivity, { person: '', type: '' }]);
            const removeActivity = (idx) => setLocalActivity(localActivity.filter((_, i) => i !== idx));

            const updateSales = (idx, colIdx, val) => {
                const newData = [...localSales];
                newData[idx] = [...newData[idx]]; 
                while(newData[idx].length <= colIdx) newData[idx].push('');
                newData[idx][colIdx] = val;
                setLocalSales(newData);
            };
            const addSales = () => {
                const newRow = [];
                const maxIdx = Math.max(colMap.date, colMap.manager, colMap.client, colMap.count, colMap.revenue);
                for(let i=0; i<=maxIdx; i++) newRow.push('');
                newRow[colMap.date] = new Date().toISOString().slice(0, 7); 
                setLocalSales([...localSales, newRow]);
            }
            const removeSales = (idx) => setLocalSales(localSales.filter((_, i) => i !== idx));

            const handleSave = () => {
                onSave(localActivity, localSales);
            };

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-[100] backdrop-blur-sm p-4">
                    <div className="bg-slate-800 w-full max-w-4xl h-[80vh] rounded-lg shadow-2xl flex flex-col border border-slate-600">
                        <div className="flex justify-between items-center p-3 border-b border-slate-700 bg-slate-900/50 rounded-t-lg">
                            <div className="flex items-center gap-2">
                                <Icons.Edit className="text-blue-400" />
                                <h2 className="text-lg font-bold text-white">데이터 편집 모드</h2>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors"><Icons.X /></button>
                        </div>

                        <div className="flex border-b border-slate-700 bg-slate-900/30">
                            <button 
                                onClick={() => setActiveTab('activity')}
                                className={`px-4 py-3 text-sm font-bold flex items-center gap-2 transition-colors ${activeTab === 'activity' ? 'text-blue-400 border-b-2 border-blue-400 bg-slate-800' : 'text-slate-400 hover:text-slate-200'}`}
                            >
                                <Icons.Briefcase size={14}/> Activity Data
                            </button>
                            <button 
                                onClick={() => setActiveTab('sales')}
                                className={`px-4 py-3 text-sm font-bold flex items-center gap-2 transition-colors ${activeTab === 'sales' ? 'text-emerald-400 border-b-2 border-emerald-400 bg-slate-800' : 'text-slate-400 hover:text-slate-200'}`}
                            >
                                <Icons.DollarSign size={14}/> Sales Data
                            </button>
                        </div>

                        <div className="flex-1 overflow-auto p-4 bg-slate-800">
                            {activeTab === 'activity' ? (
                                <div>
                                    <table className="w-full text-sm text-left text-slate-400">
                                        <thead className="text-xs uppercase bg-slate-700 text-slate-200 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2">담당자</th>
                                                <th className="px-3 py-2">활동 유형</th>
                                                <th className="px-3 py-2 text-center w-16">삭제</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-700">
                                            {localActivity.map((item, idx) => (
                                                <tr key={idx} className="hover:bg-slate-700/50">
                                                    <td className="p-1">
                                                        <input type="text" value={item.person || ''} onChange={(e) => updateActivity(idx, 'person', e.target.value)} className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white focus:border-blue-500 outline-none" placeholder="이름" />
                                                    </td>
                                                    <td className="p-1">
                                                        <input type="text" value={item.type || ''} onChange={(e) => updateActivity(idx, 'type', e.target.value)} className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white focus:border-blue-500 outline-none" placeholder="활동유형" />
                                                    </td>
                                                    <td className="p-1 text-center">
                                                        <button onClick={() => removeActivity(idx)} className="text-red-400 hover:text-red-300 p-1"><Icons.Trash size={14}/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <button onClick={addActivity} className="mt-3 flex items-center gap-1 text-xs text-blue-400 hover:text-blue-300 font-bold px-2 py-1 border border-blue-900 bg-blue-900/20 rounded">
                                        <Icons.Plus size={12}/> 행 추가
                                    </button>
                                </div>
                            ) : (
                                <div>
                                    <div className="mb-2 text-xs text-slate-500">* 날짜 형식(YYYY-MM)이 중요합니다.</div>
                                    <table className="w-full text-sm text-left text-slate-400">
                                        <thead className="text-xs uppercase bg-slate-700 text-slate-200 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2 w-24">날짜</th>
                                                <th className="px-3 py-2">담당자</th>
                                                <th className="px-3 py-2">고객사</th>
                                                <th className="px-3 py-2 w-32">매출액</th>
                                                <th className="px-3 py-2 text-center w-16">삭제</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-700">
                                            {localSales.map((row, idx) => (
                                                <tr key={idx} className="hover:bg-slate-700/50">
                                                    <td className="p-1">
                                                        <input type="text" value={row[colMap.date] || ''} onChange={(e) => updateSales(idx, colMap.date, e.target.value)} className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white focus:border-emerald-500 outline-none" placeholder="YYYY-MM" />
                                                    </td>
                                                    <td className="p-1">
                                                        <input type="text" value={row[colMap.manager] || ''} onChange={(e) => updateSales(idx, colMap.manager, e.target.value)} className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white focus:border-emerald-500 outline-none" />
                                                    </td>
                                                    <td className="p-1">
                                                        <input type="text" value={row[colMap.client] || ''} onChange={(e) => updateSales(idx, colMap.client, e.target.value)} className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white focus:border-emerald-500 outline-none" />
                                                    </td>
                                                    <td className="p-1">
                                                        <input type="text" value={row[colMap.revenue] || ''} onChange={(e) => updateSales(idx, colMap.revenue, e.target.value)} className="w-full bg-slate-900/50 border border-slate-600 rounded px-2 py-1 text-white focus:border-emerald-500 outline-none text-right" placeholder="숫자만" />
                                                    </td>
                                                    <td className="p-1 text-center">
                                                        <button onClick={() => removeSales(idx)} className="text-red-400 hover:text-red-300 p-1"><Icons.Trash size={14}/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <button onClick={addSales} className="mt-3 flex items-center gap-1 text-xs text-emerald-400 hover:text-emerald-300 font-bold px-2 py-1 border border-emerald-900 bg-emerald-900/20 rounded">
                                        <Icons.Plus size={12}/> 행 추가
                                    </button>
                                </div>
                            )}
                        </div>

                        <div className="p-3 border-t border-slate-700 bg-slate-900/50 rounded-b-lg flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded text-xs font-bold transition-colors">취소</button>
                            <button onClick={handleSave} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-bold flex items-center gap-2 transition-colors shadow-lg shadow-blue-900/50">
                                <Icons.Save size={14}/> 저장 및 적용
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        function SalesDashboard() {
            const [activityData, setActivityData] = useState([]);
            const [salesData, setSalesData] = useState([]);
            const [targetData, setTargetData] = useState([]);
            const [loading, setLoading] = useState(false);
            const [salesHeader, setSalesHeader] = useState([]);
            const [salesFirstRow, setSalesFirstRow] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [showEditor, setShowEditor] = useState(false);

            const SHEET_ID = '1W0OXOMzCvq6KlBwWpnnXQTgcOaC1gK4zftTEq5qmfns';
            const [activityGid, setActivityGid] = useState('0');
            const [salesGid, setSalesGid] = useState('1883872851');
            const [targetGid, setTargetGid] = useState('1856051626');
            const [tempSalesInput, setTempSalesInput] = useState('');

            const [colMap, setColMap] = useState({
                date: 1,      // B열
                manager: 2,   // C열
                client: 3,    // D열
                count: 4,     // E열
                revenue: 7    // H열
            });

            const fetchData = useCallback(async () => {
                setLoading(true);
                const getCsvUrl = (id, gid) => `https://docs.google.com/spreadsheets/d/${id}/export?format=csv&gid=${gid}`;
                
                try {
                    const res = await fetch(getCsvUrl(SHEET_ID, activityGid));
                    if (res.ok) {
                        const parsed = parseCSV(await res.text());
                        setActivityData(parsed.slice(1).map(r => ({ person: r[2], type: r[3] })).filter(r => r.person));
                    }
                } catch(e) { setActivityData(MOCK_ACTIVITY); }

                try {
                    const res = await fetch(getCsvUrl(SHEET_ID, salesGid));
                    if (res.ok) {
                        const parsed = parseCSV(await res.text());
                        if (parsed.length > 0) setSalesHeader(parsed[0]);
                        if (parsed.length > 1) setSalesFirstRow(parsed[1]);
                        setSalesData(parsed.slice(1));
                    }
                } catch(e) { setSalesData(MOCK_SALES); }
                
                try {
                    const res = await fetch(getCsvUrl(SHEET_ID, targetGid));
                    if (res.ok) {
                        const parsed = parseCSV(await res.text());
                        setTargetData(parsed.slice(1));
                    }
                } catch(e) { setTargetData(MOCK_TARGETS); }

                setLoading(false);
            }, [activityGid, salesGid, targetGid]);

            useEffect(() => {
                fetchData();
                let timerId;
                const scheduleNextUpdate = () => {
                    const now = new Date();
                    let target = new Date();
                    target.setHours(18, 10, 0, 0);
                    if (now >= target) target.setDate(target.getDate() + 1);
                    const msUntilTarget = target.getTime() - now.getTime();
                    timerId = setTimeout(() => {
                        fetchData();
                        scheduleNextUpdate();
                    }, msUntilTarget);
                };
                scheduleNextUpdate();
                return () => clearTimeout(timerId);
            }, [fetchData]);

            const handleApplySettings = () => {
                if (tempSalesInput) setSalesGid(extractGid(tempSalesInput));
                setTimeout(() => { fetchData(); setShowSettings(false); }, 100);
            };

            const handleEditorSave = (newActivity, newSales) => {
                setActivityData(newActivity);
                setSalesData(newSales);
                setShowEditor(false);
            };

            // --- Processed Data ---
            const processedActivityGroups = useMemo(() => {
                const groups = {};
                const source = activityData.length ? activityData : MOCK_ACTIVITY;
                
                source.forEach(item => {
                    const p = item.person;
                    const t = item.type ? item.type.trim() : '';
                    if (!p || !t || t === '기타') return; 
                    if (!groups[t]) groups[t] = {};
                    groups[t][p] = (groups[t][p] || 0) + 1;
                });

                return Object.keys(groups).map(type => {
                    const data = Object.entries(groups[type])
                        .map(([name, count]) => ({ name, count }))
                        .sort((a, b) => b.count - a.count);
                    const totalCount = data.reduce((a, c) => a + c.count, 0);
                    return { type, data, totalCount };
                }).filter(g => g.totalCount > 0).sort((a, b) => b.totalCount - a.totalCount);
            }, [activityData]);

            const processedSales = useMemo(() => {
                const aggregated = {};
                (salesData.length ? salesData : MOCK_SALES).forEach(row => {
                    if (!row) return;
                    const manager = row[colMap.manager];
                    const revStr = row[colMap.revenue];

                    if (!manager) return;
                    if (!aggregated[manager]) aggregated[manager] = { 담당자: manager, 매출액: 0 };

                    if (revStr) aggregated[manager].매출액 += parseCurrency(revStr);
                });
                return Object.values(aggregated);
            }, [salesData, colMap]);

            const processedMonthly = useMemo(() => {
                const salesByMonth = {};
                (salesData.length ? salesData : MOCK_SALES).forEach(row => {
                    if (!row) return;
                    const dateStr = row[colMap.date];
                    const revStr = row[colMap.revenue];
                    if (!dateStr || !revStr) return;
                    
                    if (!salesByMonth[dateStr]) salesByMonth[dateStr] = 0;
                    salesByMonth[dateStr] += parseCurrency(revStr);
                });

                const sourceTargets = targetData.length ? targetData : MOCK_TARGETS;
                return sourceTargets.map(row => {
                    const month = row[0];
                    const target = parseCurrency(row[1]);
                    const revenue = salesByMonth[month] || 0;
                    
                    return { month, target, revenue, rate: target > 0 ? (revenue/target*100).toFixed(1) : 0 };
                }).filter(d => d.month);
            }, [salesData, targetData, colMap]);

            const chartData = useMemo(() => processedSales.filter(d => d.매출액 > 0), [processedSales]);
            const topSales = useMemo(() => [...processedSales].filter(d => d.매출액 > 0).sort((a, b) => b.매출액 - a.매출액).slice(0, 3), [processedSales]);
            const totalRevenue = useMemo(() => processedSales.reduce((acc, curr) => acc + curr.매출액, 0), [processedSales]);

            // --- Renderers (글씨 크기 및 여백 조정) ---
            const renderActivityChart = (group, idx, Recharts) => {
                const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LabelList } = Recharts;
                // Font Size 줄임
                const CustomLabel = ({ x, y, width, value }) => value ? <text x={x+width/2} y={y-3} fill="#fff" textAnchor="middle" fontSize={11} fontWeight="bold">{value}</text> : null;
                return (
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={group.data} margin={{ top: 15, right: 10, left: -10, bottom: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            {/* XAxis, YAxis Font 줄임 */}
                            <XAxis dataKey="name" stroke="#94a3b8" tick={{fontSize: 11, fontWeight: 'bold'}} interval={0} />
                            <YAxis stroke="#94a3b8" tick={{fontSize: 10}} />
                            <Tooltip cursor={{fill: '#334155', opacity: 0.2}} contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', fontSize: '11px', color: '#fff' }} />
                            <Bar dataKey="count" fill={CHART_COLORS[idx % CHART_COLORS.length]} radius={[3, 3, 0, 0]} maxBarSize={30}>
                                <LabelList dataKey="count" content={<CustomLabel />} />
                            </Bar>
                        </BarChart>
                    </ResponsiveContainer>
                );
            };

            const renderRevenueChart = (Recharts) => {
                const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LabelList } = Recharts;
                const data = chartData.filter(d => d.매출액 > 0).sort((a, b) => b.매출액 - a.매출액);
                // Font Size 줄임
                const CustomLabel = ({ x, y, width, value }) => value ? <text x={x+width/2} y={y-5} fill="#fff" textAnchor="middle" fontSize={11} fontWeight="bold">{formatKoreanCurrency(value)}</text> : null;
                return (
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={data} margin={{ top: 20, right: 10, left: 10, bottom: 0 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis dataKey="담당자" stroke="#94a3b8" tick={{fontSize: 11, fontWeight: 'bold'}} interval={0} />
                            <YAxis stroke="#94a3b8" tick={{fontSize: 10}} tickFormatter={(val) => val>=10000 ? `${val/10000}만` : val} />
                            <Tooltip cursor={{fill: '#334155', opacity: 0.2}} contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', fontSize: '11px', color: '#fff' }} formatter={(val) => val.toLocaleString()} />
                            <Bar dataKey="매출액" fill={COLORS.revenue} radius={[4, 4, 0, 0]} maxBarSize={40}>
                                <LabelList dataKey="매출액" content={<CustomLabel />} />
                            </Bar>
                        </BarChart>
                    </ResponsiveContainer>
                );
            };

            const renderMonthlyChart = (Recharts) => {
                const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } = Recharts;
                return (
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={processedMonthly} margin={{ top: 20, right: 10, left: 10, bottom: 5 }}>
                            <CartesianGrid strokeDasharray="3 3" stroke="#334155" vertical={false} />
                            <XAxis dataKey="month" stroke="#94a3b8" tick={{fontSize: 11}} />
                            <YAxis stroke="#94a3b8" tick={{fontSize: 10}} tickFormatter={(val) => val>=100000000 ? `${val/100000000}억` : `${val/10000}만`} />
                            <Tooltip 
                                cursor={{fill: '#334155', opacity: 0.2}} 
                                contentStyle={{ backgroundColor: '#1e293b', borderColor: '#334155', fontSize: '11px', color: '#fff' }} 
                                formatter={(val) => val.toLocaleString()}
                            />
                            <Legend wrapperStyle={{fontSize: '11px', paddingTop: '5px'}} />
                            <Bar name="목표" dataKey="target" fill={COLORS.target} radius={[4, 4, 0, 0]} maxBarSize={25} />
                            <Bar name="매출" dataKey="revenue" fill={COLORS.revenue} radius={[4, 4, 0, 0]} maxBarSize={25} />
                        </BarChart>
                    </ResponsiveContainer>
                );
            };

            return (
                <div className="h-full w-full flex flex-col overflow-hidden text-slate-100 font-sans bg-slate-900">
                    {/* Header (높이 축소 h-14 -> h-12) */}
                    <div className="h-12 bg-slate-800 border-b border-slate-700 px-4 flex items-center justify-between shrink-0">
                        <div className="flex items-center gap-3">
                            <Icons.LayoutDashboard size={20} className="text-blue-500" />
                            <h1 className="text-lg font-bold text-white tracking-wide">Sales Command Center</h1>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className="text-xs text-slate-400 mr-2 hidden sm:block font-medium">자동 업데이트: 매일 18:10</span>
                            <button onClick={() => setShowEditor(true)} className="flex items-center gap-1 text-slate-300 hover:text-white px-2 py-1 hover:bg-slate-700 rounded transition-colors" title="데이터 수정">
                                <Icons.Edit size={16} /> <span className="text-xs font-bold">수정</span>
                            </button>
                            <div className="h-5 w-[1px] bg-slate-600 mx-1"></div>
                            <button onClick={() => setShowSettings(!showSettings)} className="text-slate-300 hover:text-white p-1 hover:bg-slate-700 rounded"><Icons.Settings size={18} /></button>
                            <button onClick={fetchData} className={`text-slate-300 hover:text-white p-1 hover:bg-slate-700 rounded ${loading ? 'animate-spin' : ''}`}><Icons.RefreshCw size={18} /></button>
                        </div>
                    </div>

                    {/* Data Editor Modal (유지) */}
                    {showEditor && (
                        <DataEditor 
                            activityData={activityData}
                            salesData={salesData}
                            colMap={colMap}
                            onSave={handleEditorSave}
                            onClose={() => setShowEditor(false)}
                        />
                    )}

                    {/* Settings Panel (유지) */}
                    {showSettings && (
                        <div className="absolute top-14 right-4 z-50 w-96 bg-slate-800 border border-slate-600 rounded shadow-2xl p-4 text-sm">
                            <div className="flex justify-between mb-3"><span className="font-bold text-base">데이터 매핑 설정</span><button onClick={() => setShowSettings(false)}><Icons.X size={18}/></button></div>
                            <div className="mb-3"><input type="text" value={tempSalesInput || salesGid} onChange={(e) => setTempSalesInput(e.target.value)} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-2 text-white" placeholder="시트 URL..." /></div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-slate-400 text-xs">날짜 (idx)</label><input type="number" value={colMap.date} onChange={(e) => setColMap({...colMap, date: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white"/></div>
                                <div><label className="text-slate-400 text-xs">담당자 (idx)</label><input type="number" value={colMap.manager} onChange={(e) => setColMap({...colMap, manager: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white"/></div>
                                <div><label className="text-slate-400 text-xs">계약처 (idx)</label><input type="number" value={colMap.client} onChange={(e) => setColMap({...colMap, client: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white"/></div>
                                <div><label className="text-slate-400 text-xs">매출액 (idx)</label><input type="number" value={colMap.revenue} onChange={(e) => setColMap({...colMap, revenue: parseInt(e.target.value)})} className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1 text-white"/></div>
                            </div>
                            <button onClick={handleApplySettings} className="mt-4 w-full bg-blue-600 py-2 rounded text-white font-bold text-sm hover:bg-blue-500">저장 및 불러오기</button>
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="flex-1 p-3 overflow-hidden grid grid-cols-12 gap-3">
                        
                        {/* 1. Daily Activities (Left Column, 3/12 width) */}
                        <div className="col-span-3 bg-slate-800/40 border border-slate-700/50 rounded-xl p-3 flex flex-col h-full overflow-hidden shadow-lg">
                            <div className="flex items-center gap-2 mb-2 text-blue-400 font-bold text-base shrink-0 border-b border-slate-700/50 pb-2">
                                <Icons.Briefcase size={16}/> Daily Activities
                            </div>
                            <div className="flex-1 flex flex-col gap-2 overflow-hidden">
                                {processedActivityGroups.map((g, i) => (
                                    <div key={g.type} className="flex-1 min-h-0 bg-slate-900/40 rounded-lg p-2 flex flex-col border border-slate-700/30">
                                        <span className="text-xs font-bold text-slate-200 flex items-center gap-2 mb-1 px-1 shrink-0">
                                            <Icons.Layers size={12} style={{color:CHART_COLORS[i%8]}}/> {g.type} <span className="text-slate-400 font-normal">({g.totalCount})</span>
                                        </span>
                                        <div className="flex-1 min-h-0"><SafeRecharts render={(r) => renderActivityChart(g, i, r)} /></div>
                                    </div>
                                ))}
                                {processedActivityGroups.length === 0 && <div className="flex-1 flex items-center justify-center text-sm text-slate-500">데이터 없음</div>}
                            </div>
                        </div>

                        {/* Right Column (9/12 width) */}
                        <div className="col-span-9 flex flex-col gap-3 h-full">
                            
                            {/* Row 1: Revenue & Sales Top 3 (Height 25% 축소) */}
                            <div className="h-[25%] grid grid-cols-2 gap-3">
                                {/* Revenue */}
                                <div className="bg-slate-800/40 border border-slate-700/50 rounded-xl p-3 flex flex-col min-h-0 shadow-lg">
                                    <div className="flex items-center gap-2 mb-1 text-emerald-400 font-bold text-base">
                                        <Icons.DollarSign size={16}/> Revenue Status <span className="text-white ml-1 text-sm">[총 매출 {formatKoreanCurrency(totalRevenue)}원]</span>
                                    </div>
                                    <div className="flex-1"><SafeRecharts render={renderRevenueChart} /></div>
                                </div>

                                {/* Sales Top 3 */}
                                <div className="bg-slate-800/40 border border-slate-700/50 rounded-xl flex flex-col overflow-hidden shadow-lg">
                                    <div className="h-8 px-3 flex items-center gap-2 bg-slate-700/30 border-b border-slate-700/50 text-yellow-400 font-bold text-base"><Icons.Crown size={16}/> Sales Top 3</div>
                                    <div className="flex-1 overflow-auto p-1">
                                        <table className="w-full text-xs text-left text-slate-300">
                                            <thead className="bg-slate-700/50 text-slate-100 sticky top-0 font-bold">
                                                <tr><th className="p-2 text-center w-12">순위</th><th className="p-2">담당자</th><th className="p-2 text-right">매출액</th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-700/30 text-sm">
                                                {topSales.map((r, i) => (
                                                    <tr key={i} className="hover:bg-slate-700/30">
                                                        <td className="p-2 text-center font-bold text-yellow-400">{i+1}</td>
                                                        <td className="p-2 text-white font-bold">{r.담당자}</td>
                                                        <td className="p-2 text-right font-mono text-emerald-400 font-bold">{formatKoreanCurrency(r.매출액)}</td>
                                                    </tr>
                                                ))}
                                                {topSales.length === 0 && <tr><td colSpan="3" className="p-4 text-center text-slate-500">데이터 없음</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            {/* Row 2: Monthly Target vs Revenue (Height 30% 축소) */}
                            <div className="h-[30%] bg-slate-800/40 border border-slate-700/50 rounded-xl p-3 flex flex-col min-h-0 shadow-lg">
                                <div className="flex items-center justify-between mb-1 px-1">
                                    <div className="flex items-center gap-2 text-slate-100 font-bold text-base">
                                        <Icons.Target size={16} className="text-blue-400"/> Monthly Target vs Revenue
                                    </div>
                                    <span className="text-xs text-slate-400">단위: 원 (목표 대비 실적)</span>
                                </div>
                                <div className="flex-1"><SafeRecharts render={renderMonthlyChart} /></div>
                            </div>

                            {/* Row 3: Nara Market & Support Business (Remaining Height 확장 ~45%) */}
                            <div className="flex-1 bg-slate-800/40 border border-slate-700/50 rounded-xl flex flex-col overflow-hidden shadow-lg">
                                <div className="h-10 px-4 flex items-center justify-between bg-slate-700/30 border-b border-slate-700/50">
                                    <div className="flex items-center gap-2 text-indigo-400 font-bold text-base">
                                        <Icons.Building size={18}/> 나라장터 입찰 및 지원사업
                                    </div>
                                    <button className="text-xs bg-indigo-500/20 hover:bg-indigo-500/40 text-indigo-300 px-3 py-1.5 rounded transition-colors font-bold">새로고침</button>
                                </div>
                                <div className="flex-1 p-4 overflow-auto">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 h-full">
                                        <div className="bg-slate-900/40 rounded-lg p-3 border border-slate-700/50 flex flex-col h-full">
                                            <h3 className="text-sm text-slate-300 font-bold mb-3 border-b border-slate-700 pb-2">입찰 공고 (최근 5건)</h3>
                                            <ul className="space-y-3 text-sm text-slate-300 flex-1 overflow-auto">
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors border-b border-slate-800/50"><span className="truncate flex-1 font-medium">2025년도 정보시스템 유지관리 사업</span><span className="text-amber-500 font-bold ml-3 shrink-0">D-2</span></li>
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors border-b border-slate-800/50"><span className="truncate flex-1 font-medium">공공데이터 개방 및 품질진단 용역</span><span className="text-slate-400 font-bold ml-3 shrink-0">D-5</span></li>
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors border-b border-slate-800/50"><span className="truncate flex-1 font-medium">스마트 시티 통합 플랫폼 구축</span><span className="text-slate-400 font-bold ml-3 shrink-0">D-7</span></li>
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors border-b border-slate-800/50"><span className="truncate flex-1 font-medium">지능형 교통체계(ITS) 구축 사업</span><span className="text-slate-400 font-bold ml-3 shrink-0">D-10</span></li>
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors"><span className="truncate flex-1 font-medium">차세대 지방세정보시스템 유지관리</span><span className="text-slate-400 font-bold ml-3 shrink-0">D-12</span></li>
                                            </ul>
                                        </div>
                                        <div className="bg-slate-900/40 rounded-lg p-3 border border-slate-700/50 flex flex-col h-full">
                                            <h3 className="text-sm text-slate-300 font-bold mb-3 border-b border-slate-700 pb-2">지원사업 공고 (추천)</h3>
                                            <ul className="space-y-3 text-sm text-slate-300 flex-1 overflow-auto">
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors border-b border-slate-800/50"><span className="truncate flex-1 font-medium">AI 바우처 지원사업 수요기업 모집</span><span className="text-emerald-500 font-bold ml-3 shrink-0">접수중</span></li>
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors border-b border-slate-800/50"><span className="truncate flex-1 font-medium">데이터 바우처 지원사업 하반기</span><span className="text-red-400 font-bold ml-3 shrink-0">마감임박</span></li>
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors border-b border-slate-800/50"><span className="truncate flex-1 font-medium">클라우드 바우처 수요기업 모집</span><span className="text-emerald-500 font-bold ml-3 shrink-0">접수중</span></li>
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors border-b border-slate-800/50"><span className="truncate flex-1 font-medium">비대면 서비스 바우처 플랫폼</span><span className="text-slate-400 font-bold ml-3 shrink-0">예정</span></li>
                                                <li className="flex justify-between hover:bg-slate-800 p-2 rounded cursor-pointer transition-colors"><span className="truncate flex-1 font-medium">스마트 공방 기술보급 사업</span><span className="text-slate-400 font-bold ml-3 shrink-0">예정</span></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SalesDashboard />);
    </script>
</body>
</html>
